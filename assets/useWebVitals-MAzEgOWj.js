import{r as pt}from"./react-B8DbRJ_3.js";import{W as O}from"./index-BUTrnasD.js";var F,et=-1,E=function(t){addEventListener("pageshow",function(n){n.persisted&&(et=n.timeStamp,t(n))},!0)},_=function(){var t=self.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0];if(t&&t.responseStart>0&&t.responseStart<performance.now())return t},M=function(){var t=_();return t&&t.activationStart||0},m=function(t,n){var e=_(),r="navigate";return et>=0?r="back-forward-cache":e&&(document.prerendering||M()>0?r="prerender":document.wasDiscarded?r="restore":e.type&&(r=e.type.replace(/_/g,"-"))),{name:t,value:n===void 0?-1:n,rating:"good",delta:0,entries:[],id:"v4-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:r}},b=function(t,n,e){try{if(PerformanceObserver.supportedEntryTypes.includes(t)){var r=new PerformanceObserver(function(o){Promise.resolve().then(function(){n(o.getEntries())})});return r.observe(Object.assign({type:t,buffered:!0},e||{})),r}}catch{}},g=function(t,n,e,r){var o,i;return function(s){n.value>=0&&(s||r)&&((i=n.value-(o||0))||o===void 0)&&(o=n.value,n.delta=i,n.rating=function(u,l){return u>l[1]?"poor":u>l[0]?"needs-improvement":"good"}(n.value,e),t(n))}},V=function(t){requestAnimationFrame(function(){return requestAnimationFrame(function(){return t()})})},P=function(t){document.addEventListener("visibilitychange",function(){document.visibilityState==="hidden"&&t()})},B=function(t){var n=!1;return function(){n||(t(),n=!0)}},y=-1,J=function(){return document.visibilityState!=="hidden"||document.prerendering?1/0:0},k=function(t){document.visibilityState==="hidden"&&y>-1&&(y=t.type==="visibilitychange"?t.timeStamp:0,ft())},z=function(){addEventListener("visibilitychange",k,!0),addEventListener("prerenderingchange",k,!0)},ft=function(){removeEventListener("visibilitychange",k,!0),removeEventListener("prerenderingchange",k,!0)},ot=function(){return y<0&&(y=J(),z(),E(function(){setTimeout(function(){y=J(),z()},0)})),{get firstHiddenTime(){return y}}},I=function(t){document.prerendering?addEventListener("prerenderingchange",function(){return t()},!0):t()},Q=[1800,3e3],at=function(t,n){n=n||{},I(function(){var e,r=ot(),o=m("FCP"),i=b("paint",function(s){s.forEach(function(u){u.name==="first-contentful-paint"&&(i.disconnect(),u.startTime<r.firstHiddenTime&&(o.value=Math.max(u.startTime-M(),0),o.entries.push(u),e(!0)))})});i&&(e=g(t,o,Q,n.reportAllChanges),E(function(s){o=m("FCP"),e=g(t,o,Q,n.reportAllChanges),V(function(){o.value=performance.now()-s.timeStamp,e(!0)})}))})},G=[.1,.25],vt=function(t,n){n=n||{},at(B(function(){var e,r=m("CLS",0),o=0,i=[],s=function(l){l.forEach(function(p){if(!p.hadRecentInput){var h=i[0],S=i[i.length-1];o&&p.startTime-S.startTime<1e3&&p.startTime-h.startTime<5e3?(o+=p.value,i.push(p)):(o=p.value,i=[p])}}),o>r.value&&(r.value=o,r.entries=i,e())},u=b("layout-shift",s);u&&(e=g(t,r,G,n.reportAllChanges),P(function(){s(u.takeRecords()),e(!0)}),E(function(){o=0,r=m("CLS",0),e=g(t,r,G,n.reportAllChanges),V(function(){return e()})}),setTimeout(e,0))}))},rt=0,A=1/0,C=0,mt=function(t){t.forEach(function(n){n.interactionId&&(A=Math.min(A,n.interactionId),C=Math.max(C,n.interactionId),rt=C?(C-A)/7+1:0)})},it=function(){return F?rt:performance.interactionCount||0},gt=function(){"interactionCount"in performance||F||(F=b("event",mt,{type:"event",buffered:!0,durationThreshold:0}))},v=[],L=new Map,st=0,ht=function(){var t=Math.min(v.length-1,Math.floor((it()-st)/50));return v[t]},St=[],yt=function(t){if(St.forEach(function(o){return o(t)}),t.interactionId||t.entryType==="first-input"){var n=v[v.length-1],e=L.get(t.interactionId);if(e||v.length<10||t.duration>n.latency){if(e)t.duration>e.latency?(e.entries=[t],e.latency=t.duration):t.duration===e.latency&&t.startTime===e.entries[0].startTime&&e.entries.push(t);else{var r={id:t.interactionId,latency:t.duration,entries:[t]};L.set(r.id,r),v.push(r)}v.sort(function(o,i){return i.latency-o.latency}),v.length>10&&v.splice(10).forEach(function(o){return L.delete(o.id)})}}},ct=function(t){var n=self.requestIdleCallback||self.setTimeout,e=-1;return t=B(t),document.visibilityState==="hidden"?t():(e=n(t),P(t)),e},K=[200,500],Et=function(t,n){"PerformanceEventTiming"in self&&"interactionId"in PerformanceEventTiming.prototype&&(n=n||{},I(function(){var e;gt();var r,o=m("INP"),i=function(u){ct(function(){u.forEach(yt);var l=ht();l&&l.latency!==o.value&&(o.value=l.latency,o.entries=l.entries,r())})},s=b("event",i,{durationThreshold:(e=n.durationThreshold)!==null&&e!==void 0?e:40});r=g(t,o,K,n.reportAllChanges),s&&(s.observe({type:"first-input",buffered:!0}),P(function(){i(s.takeRecords()),r(!0)}),E(function(){st=it(),v.length=0,L.clear(),o=m("INP"),r=g(t,o,K,n.reportAllChanges)}))}))},X=[2500,4e3],q={},bt=function(t,n){n=n||{},I(function(){var e,r=ot(),o=m("LCP"),i=function(l){n.reportAllChanges||(l=l.slice(-1)),l.forEach(function(p){p.startTime<r.firstHiddenTime&&(o.value=Math.max(p.startTime-M(),0),o.entries=[p],e())})},s=b("largest-contentful-paint",i);if(s){e=g(t,o,X,n.reportAllChanges);var u=B(function(){q[o.id]||(i(s.takeRecords()),s.disconnect(),q[o.id]=!0,e(!0))});["keydown","click"].forEach(function(l){addEventListener(l,function(){return ct(u)},{once:!0,capture:!0})}),P(u),E(function(l){o=m("LCP"),e=g(t,o,X,n.reportAllChanges),V(function(){o.value=performance.now()-l.timeStamp,q[o.id]=!0,e(!0)})})}})},Y=[800,1800],Tt=function t(n){document.prerendering?I(function(){return t(n)}):document.readyState!=="complete"?addEventListener("load",function(){return t(n)},!0):setTimeout(n,0)},wt=function(t,n){n=n||{};var e=m("TTFB"),r=g(t,e,Y,n.reportAllChanges);Tt(function(){var o=_();o&&(e.value=Math.max(o.responseStart-M(),0),e.entries=[o],r(!0),E(function(){e=m("TTFB",0),(r=g(t,e,Y,n.reportAllChanges))(!0)}))})};const f=[];for(let t=0;t<256;++t)f.push((t+256).toString(16).slice(1));function Ct(t,n=0){return(f[t[n+0]]+f[t[n+1]]+f[t[n+2]]+f[t[n+3]]+"-"+f[t[n+4]]+f[t[n+5]]+"-"+f[t[n+6]]+f[t[n+7]]+"-"+f[t[n+8]]+f[t[n+9]]+"-"+f[t[n+10]]+f[t[n+11]]+f[t[n+12]]+f[t[n+13]]+f[t[n+14]]+f[t[n+15]]).toLowerCase()}let D;const Lt=new Uint8Array(16);function kt(){if(!D){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");D=crypto.getRandomValues.bind(crypto)}return D(Lt)}const Mt=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Z={randomUUID:Mt};function x(t,n,e){if(Z.randomUUID&&!n&&!t)return Z.randomUUID();t=t||{};const r=t.random||(t.rng||kt)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,Ct(r)}const tt=window.location,R=tt.protocol+"//"+tt.host,Pt=R+"/loki/api/v1/push",It=R+"/influx/api/v2/write",Nt=R+"/tempo/api/push",nt={CLS:"Cumulative Layout Shift",FID:"First Input Delay",FCP:"First Contentful Paint",INP:"Interaction to Next Paint",LCP:"Largest Contentful Paint",TTFB:"Time to First Byte"};function dt(t){const n=new Map;for(const r of t){const o=JSON.stringify(r);n.set(o,(n.get(o)||0)+1)}const e=[];for(const[r,o]of n.entries()){const s={...JSON.parse(r),count:o};e.push(s)}return e}const At=t=>t.map(n=>`${n.metric.name},page=${n.page},rating=${n.metric.rating||"unknown"} value=${n.metric.value} ${Date.now()*1e6}`).join(`
`),qt=async t=>{try{await fetch(It,{method:"POST",headers:{"Content-Type":"text/plain"},body:t})}catch(n){throw console.error("Failed to push metrics:",n),n}},Dt=async t=>{try{await fetch(Pt,{method:"POST",headers:{"Content-Type":"application/json"},body:t})}catch(n){throw console.error("Failed to push logs:",n),n}},Ft=async(t,n)=>{const e=await t.map(async({metric:o,page:i,traceId:s})=>{var p,h;let u=o.entries;o.name==="INP"&&(u=dt(o.entries));const l=`job=WebVitals name=${o.name} description="${nt[o.name]}" traceId=${s} instance=${n} page="${i}" value=${o.value} rating=${o.rating||"unknown"} delta=${((p=o.delta)==null?void 0:p.toString())||"N/A"} entries=${JSON.stringify(u||[])}`;return{stream:{level:"info",job:"webVitals",name:o.name,metricName:o.name,metricLabel:"page",instance:n,description:nt[o.name],value:o.value.toString(),rating:o.rating||"unknown",delta:((h=o.delta)==null?void 0:h.toString())||"N/A",traceId:s,page:i,hasMetrics:!0},values:[[String(Date.now()*1e6),l]]}}),r=await Promise.all(e);return JSON.stringify(r?{streams:r}:{streams:[]})},xt=(t,n)=>t.map(({metric:e,page:r,traceId:o})=>({metric:e,page:r,traceId:o,instance:n})),Ot=(t,n,e,r)=>{var W,U,j,H;const o=Math.floor(Date.now()*1e3),i=x().replace(/-/g,""),s=(a,d,N,c,T,w)=>({id:x().replace(/-/g,""),traceId:N,parentId:c,name:a,timestamp:Math.floor(Date.now()*1e3)+Math.floor(T*1e3),duration:Math.floor(d*1e3),tags:{"web.vital.event":a,"web.vital.page":n,"web.vital.name":t.name,"web.vital.description":t.description,"qryn-view.instance":t.instance,...w},localEndpoint:{serviceName:a}}),u=(a,d)=>{var T,w;const N=Math.floor(Date.now()*1e3),c=(T=a.entries)==null?void 0:T[0];return{id:i,traceId:e,timestamp:N,duration:Math.floor(c.duration*1e3),name:"TTFB",tags:{"http.method":"GET","http.path":d,"web.vital.name":"TTFB","web.vital.description":a.description,"web.vital.value":a.value.toString(),"web.vital.rating":a.rating||"unknown","web.vital.delta":((w=a.delta)==null?void 0:w.toString())||"N/A","ttfb.fetch_time":(c.fetchStart-c.navigationStart).toString(),"ttfb.dns_time":(c.domainLookupEnd-c.domainLookupStart).toString(),"ttfb.connect_time":(c.connectEnd-c.connectStart).toString(),"ttfb.request_time":(c.responseStart-c.requestStart).toString(),"ttfb.response_time":(c.responseEnd-c.responseStart).toString(),"http.response_content_length":c.encodedBodySize.toString(),"http.response_transfer_size":c.transferSize.toString(),"http.response_decoded_content_length":c.decodedBodySize.toString(),"http.status_code":c.responseStatus.toString(),"network.protocol.name":c.nextHopProtocol||"unknown","network.protocol.version":c.nextHopProtocol?c.nextHopProtocol.split("/")[1]:"unknown","ttfb.initiatorType":c.initiatorType,"ttfb.deliveryType":c.deliveryType,"ttfb.renderBlockingStatus":c.renderBlockingStatus,"ttfb.workerStart":c.workerStart.toString(),"ttfb.redirectCount":c.redirectCount.toString(),"performance.domInteractive":c.domInteractive.toString(),"performance.domContentLoadedEvent":(c.domContentLoadedEventEnd-c.domContentLoadedEventStart).toString(),"performance.loadEvent":(c.loadEventEnd-c.loadEventStart).toString(),"qryn-view.instance":r},localEndpoint:{serviceName:"Web Vitals"}}},l=(a,d)=>({id:i,traceId:e,timestamp:o,duration:Math.floor(a.value*1e3),name:"INP",tags:{"http.method":"GET","inp.name":a.name,"inp.page":d,"inp.value":a.value,"inp.rating":a.rating,"inp.delta":a.delta,"qryn-view.instance":r},localEndpoint:{serviceName:"Web Vitals"}});let p={id:i,traceId:e,timestamp:o,duration:Math.floor(t.value*1e3),name:t.name,localEndpoint:{serviceName:"Web Vitals"}},h={"http.method":"GET","http.path":n,"web.vital.name":t.name,"web.vital.description":t.description,"web.vital.value":t.value.toString(),"web.vital.rating":t.rating||"unknown","web.vital.delta":((W=t.delta)==null?void 0:W.toString())||"N/A","qryn-view.instance":r};p.tags=h;let S=[];if(t.name==="TTFB"){p=u(t,n);const a=(U=t.entries)==null?void 0:U[0];if(a){const d=a.startTime;S=[s("Navigation Start",a.startTime,e,i,a.startTime,{"ttfb.startTime":a.startTime}),s("Fetch Start",a.fetchStart,e,i,a.fetchStart,{"ttfb.fetchStart":a.fetchStart}),s("Domain Lookup",a.domainLookupEnd-a.domainLookupStart,e,i,a.domainLookupStart-d,{"ttfb.domainLookupStart":a.domainLookupStart,"ttfb.domainLookupEnd":a.domainLookupEnd}),s("Connect",a.connectEnd-a.connectStart,e,i,a.connectStart-d,{"ttfb.connectStart":a.connectStart,"ttfb.connectEnd":a.connectEnd}),s("Request/Response",a.responseEnd-a.requestStart,e,i,a.requestStart-d,{"ttfb.requestStart":a.requestStart,"ttfb.requestEnd":a.requestEnd}),s("Unload Event",a.unloadEventEnd-a.unloadEventStart,e,i,a.unloadEventStart-d,{"ttfb.unloadEventStart":a.unloadEventStart,"ttfb.unloadEventEnd":a.unloadEventEnd}),s("DOM Interactive",0,e,i,a.domInteractive-d,{"ttfb.domInteractive":a.domInteractive}),s("DOM Content Loaded",a.domContentLoadedEventEnd-a.domContentLoadedEventStart,e,i,a.domContentLoadedEventStart-d,{"ttfb.domContentLoadedEventStart":a.domContentLoadedEventStart,"ttfb.domContentLoadedEventEnd":a.domContentLoadedEventEnd}),s("DOM Complete",0,e,i,a.domComplete-d,{"ttfb.domComplete":a.domComplete}),s("Load Event",a.loadEventEnd-a.loadEventStart,e,i,a.loadEventStart-d,{"ttfb.loadEventStart":a.loadEventStart,"ttfb.loadEventEnd":a.loadEventEnd})]}}if(t.name==="INP"){p=l(t,n);const a=(j=dt(t.entries))==null?void 0:j.map(d=>s(d.name,Math.round(d.processingEnd-d.processingStart),e,i,Math.round(d.processingStart),{"inp.name":d.name,"inp.interactionId":d.interactionId,"inp.startTime":d.startTime,"inp.processingStart":d.processingStart,"inp.processingEnd":d.processingEnd,"inp.cancellable":d.cancelable,"inp.count":d.count,"qryn-view.instance":r}));(a==null?void 0:a.length)>0&&(S=a)}let $=[p];return((H=Object.keys(S))==null?void 0:H.length)>0&&($=[p,...S]),$},_t=async t=>{try{await fetch(Nt,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}catch(n){console.error("Error sending trace data:",n)}};async function ut(t){if(t.size!==0)try{const{qrynInstance:n}=O.getState(),e=Array.from(t),r=await Ft(e,n).then(u=>u),o=xt(e,n),i=At(o),s=e.flatMap(({metric:u,page:l,traceId:p,instance:h})=>Ot(u,l,p,h));await Promise.all([qt(i),Dt(r),_t(s)]),t.clear()}catch(n){console.error("Error flushing queue:",n)}}const lt=async t=>{document.visibilityState==="hidden"&&await ut(t)},Vt=(t,n)=>{const{qrynInstance:e}=O.getState(),r=async o=>{const i=x().replace(/-/g,"");t.add({metric:o,page:n,traceId:i,instance:e})};vt(r),at(r),Et(r),bt(r),wt(r),addEventListener("visibilitychange",()=>lt(t))},$t=({page:t})=>{const{webVitalsActive:n}=O();pt.useEffect(()=>{const e=new Set;return n&&Vt(e,t),()=>{n&&(document.removeEventListener("visibilitychange",()=>lt(e)),ut(e))}},[])};export{Pt as L,It as M,Nt as T,$t as u,x as v};
