import{r as ft}from"./react-B8DbRJ_3.js";import{W as _}from"./index-a4ur-NK3.js";var x,ot=-1,E=function(t){addEventListener("pageshow",function(n){n.persisted&&(ot=n.timeStamp,t(n))},!0)},V=function(){var t=self.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0];if(t&&t.responseStart>0&&t.responseStart<performance.now())return t},P=function(){var t=V();return t&&t.activationStart||0},m=function(t,n){var e=V(),r="navigate";return ot>=0?r="back-forward-cache":e&&(document.prerendering||P()>0?r="prerender":document.wasDiscarded?r="restore":e.type&&(r=e.type.replace(/_/g,"-"))),{name:t,value:n===void 0?-1:n,rating:"good",delta:0,entries:[],id:"v4-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:r}},b=function(t,n,e){try{if(PerformanceObserver.supportedEntryTypes.includes(t)){var r=new PerformanceObserver(function(o){Promise.resolve().then(function(){n(o.getEntries())})});return r.observe(Object.assign({type:t,buffered:!0},e||{})),r}}catch{}},g=function(t,n,e,r){var o,i;return function(s){n.value>=0&&(s||r)&&((i=n.value-(o||0))||o===void 0)&&(o=n.value,n.delta=i,n.rating=function(u,l){return u>l[1]?"poor":u>l[0]?"needs-improvement":"good"}(n.value,e),t(n))}},B=function(t){requestAnimationFrame(function(){return requestAnimationFrame(function(){return t()})})},I=function(t){document.addEventListener("visibilitychange",function(){document.visibilityState==="hidden"&&t()})},R=function(t){var n=!1;return function(){n||(t(),n=!0)}},y=-1,z=function(){return document.visibilityState!=="hidden"||document.prerendering?1/0:0},M=function(t){document.visibilityState==="hidden"&&y>-1&&(y=t.type==="visibilitychange"?t.timeStamp:0,vt())},Q=function(){addEventListener("visibilitychange",M,!0),addEventListener("prerenderingchange",M,!0)},vt=function(){removeEventListener("visibilitychange",M,!0),removeEventListener("prerenderingchange",M,!0)},at=function(){return y<0&&(y=z(),Q(),E(function(){setTimeout(function(){y=z(),Q()},0)})),{get firstHiddenTime(){return y}}},N=function(t){document.prerendering?addEventListener("prerenderingchange",function(){return t()},!0):t()},G=[1800,3e3],rt=function(t,n){n=n||{},N(function(){var e,r=at(),o=m("FCP"),i=b("paint",function(s){s.forEach(function(u){u.name==="first-contentful-paint"&&(i.disconnect(),u.startTime<r.firstHiddenTime&&(o.value=Math.max(u.startTime-P(),0),o.entries.push(u),e(!0)))})});i&&(e=g(t,o,G,n.reportAllChanges),E(function(s){o=m("FCP"),e=g(t,o,G,n.reportAllChanges),B(function(){o.value=performance.now()-s.timeStamp,e(!0)})}))})},K=[.1,.25],mt=function(t,n){n=n||{},rt(R(function(){var e,r=m("CLS",0),o=0,i=[],s=function(l){l.forEach(function(p){if(!p.hadRecentInput){var h=i[0],S=i[i.length-1];o&&p.startTime-S.startTime<1e3&&p.startTime-h.startTime<5e3?(o+=p.value,i.push(p)):(o=p.value,i=[p])}}),o>r.value&&(r.value=o,r.entries=i,e())},u=b("layout-shift",s);u&&(e=g(t,r,K,n.reportAllChanges),I(function(){s(u.takeRecords()),e(!0)}),E(function(){o=0,r=m("CLS",0),e=g(t,r,K,n.reportAllChanges),B(function(){return e()})}),setTimeout(e,0))}))},it=0,q=1/0,C=0,gt=function(t){t.forEach(function(n){n.interactionId&&(q=Math.min(q,n.interactionId),C=Math.max(C,n.interactionId),it=C?(C-q)/7+1:0)})},st=function(){return x?it:performance.interactionCount||0},ht=function(){"interactionCount"in performance||x||(x=b("event",gt,{type:"event",buffered:!0,durationThreshold:0}))},v=[],k=new Map,ct=0,St=function(){var t=Math.min(v.length-1,Math.floor((st()-ct)/50));return v[t]},yt=[],Et=function(t){if(yt.forEach(function(o){return o(t)}),t.interactionId||t.entryType==="first-input"){var n=v[v.length-1],e=k.get(t.interactionId);if(e||v.length<10||t.duration>n.latency){if(e)t.duration>e.latency?(e.entries=[t],e.latency=t.duration):t.duration===e.latency&&t.startTime===e.entries[0].startTime&&e.entries.push(t);else{var r={id:t.interactionId,latency:t.duration,entries:[t]};k.set(r.id,r),v.push(r)}v.sort(function(o,i){return i.latency-o.latency}),v.length>10&&v.splice(10).forEach(function(o){return k.delete(o.id)})}}},dt=function(t){var n=self.requestIdleCallback||self.setTimeout,e=-1;return t=R(t),document.visibilityState==="hidden"?t():(e=n(t),I(t)),e},X=[200,500],bt=function(t,n){"PerformanceEventTiming"in self&&"interactionId"in PerformanceEventTiming.prototype&&(n=n||{},N(function(){var e;ht();var r,o=m("INP"),i=function(u){dt(function(){u.forEach(Et);var l=St();l&&l.latency!==o.value&&(o.value=l.latency,o.entries=l.entries,r())})},s=b("event",i,{durationThreshold:(e=n.durationThreshold)!==null&&e!==void 0?e:40});r=g(t,o,X,n.reportAllChanges),s&&(s.observe({type:"first-input",buffered:!0}),I(function(){i(s.takeRecords()),r(!0)}),E(function(){ct=st(),v.length=0,k.clear(),o=m("INP"),r=g(t,o,X,n.reportAllChanges)}))}))},Y=[2500,4e3],D={},Tt=function(t,n){n=n||{},N(function(){var e,r=at(),o=m("LCP"),i=function(l){n.reportAllChanges||(l=l.slice(-1)),l.forEach(function(p){p.startTime<r.firstHiddenTime&&(o.value=Math.max(p.startTime-P(),0),o.entries=[p],e())})},s=b("largest-contentful-paint",i);if(s){e=g(t,o,Y,n.reportAllChanges);var u=R(function(){D[o.id]||(i(s.takeRecords()),s.disconnect(),D[o.id]=!0,e(!0))});["keydown","click"].forEach(function(l){addEventListener(l,function(){return dt(u)},{once:!0,capture:!0})}),I(u),E(function(l){o=m("LCP"),e=g(t,o,Y,n.reportAllChanges),B(function(){o.value=performance.now()-l.timeStamp,D[o.id]=!0,e(!0)})})}})},Z=[800,1800],wt=function t(n){document.prerendering?N(function(){return t(n)}):document.readyState!=="complete"?addEventListener("load",function(){return t(n)},!0):setTimeout(n,0)},Ct=function(t,n){n=n||{};var e=m("TTFB"),r=g(t,e,Z,n.reportAllChanges);wt(function(){var o=V();o&&(e.value=Math.max(o.responseStart-P(),0),e.entries=[o],r(!0),E(function(){e=m("TTFB",0),(r=g(t,e,Z,n.reportAllChanges))(!0)}))})},f=[];for(var F=0;F<256;++F)f.push((F+256).toString(16).slice(1));function Lt(t,n=0){return(f[t[n+0]]+f[t[n+1]]+f[t[n+2]]+f[t[n+3]]+"-"+f[t[n+4]]+f[t[n+5]]+"-"+f[t[n+6]]+f[t[n+7]]+"-"+f[t[n+8]]+f[t[n+9]]+"-"+f[t[n+10]]+f[t[n+11]]+f[t[n+12]]+f[t[n+13]]+f[t[n+14]]+f[t[n+15]]).toLowerCase()}var L,kt=new Uint8Array(16);function Mt(){if(!L&&(L=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!L))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return L(kt)}var Pt=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const tt={randomUUID:Pt};function O(t,n,e){if(tt.randomUUID&&!n&&!t)return tt.randomUUID();t=t||{};var r=t.random||(t.rng||Mt)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,Lt(r)}const nt=window.location,$=nt.protocol+"//"+nt.host,It=$+"/loki/api/v1/push",Nt=$+"/influx/api/v2/write",At=$+"/tempo/api/push",et={CLS:"Cumulative Layout Shift",FID:"First Input Delay",FCP:"First Contentful Paint",INP:"Interaction to Next Paint",LCP:"Largest Contentful Paint",TTFB:"Time to First Byte"};function ut(t){const n=new Map;for(const r of t){const o=JSON.stringify(r);n.set(o,(n.get(o)||0)+1)}const e=[];for(const[r,o]of n.entries()){const s={...JSON.parse(r),count:o};e.push(s)}return e}const qt=t=>t.map(n=>`${n.metric.name},page=${n.page},rating=${n.metric.rating||"unknown"} value=${n.metric.value} ${Date.now()*1e6}`).join(`
`),Dt=async t=>{try{await fetch(Nt,{method:"POST",headers:{"Content-Type":"text/plain"},body:t})}catch(n){throw console.error("Failed to push metrics:",n),n}},Ft=async t=>{try{await fetch(It,{method:"POST",headers:{"Content-Type":"application/json"},body:t})}catch(n){throw console.error("Failed to push logs:",n),n}},xt=async(t,n)=>{const e=await t.map(async({metric:o,page:i,traceId:s})=>{var p,h;let u=o.entries;o.name==="INP"&&(u=ut(o.entries));const l=`job=WebVitals name=${o.name} description="${et[o.name]}" traceId=${s} instance=${n} page="${i}" value=${o.value} rating=${o.rating||"unknown"} delta=${((p=o.delta)==null?void 0:p.toString())||"N/A"} entries=${JSON.stringify(u||[])}`;return{stream:{level:"info",job:"webVitals",name:o.name,metricName:o.name,metricLabel:"page",instance:n,description:et[o.name],value:o.value.toString(),rating:o.rating||"unknown",delta:((h=o.delta)==null?void 0:h.toString())||"N/A",traceId:s,page:i,hasMetrics:!0},values:[[String(Date.now()*1e6),l]]}}),r=await Promise.all(e);return JSON.stringify(r?{streams:r}:{streams:[]})},Ot=(t,n)=>t.map(({metric:e,page:r,traceId:o})=>({metric:e,page:r,traceId:o,instance:n})),_t=(t,n,e,r)=>{var U,j,H,J;const o=Math.floor(Date.now()*1e3),i=O().replace(/-/g,""),s=(a,d,A,c,T,w)=>({id:O().replace(/-/g,""),traceId:A,parentId:c,name:a,timestamp:Math.floor(Date.now()*1e3)+Math.floor(T*1e3),duration:Math.floor(d*1e3),tags:{"web.vital.event":a,"web.vital.page":n,"web.vital.name":t.name,"web.vital.description":t.description,"qryn-view.instance":t.instance,...w},localEndpoint:{serviceName:a}}),u=(a,d)=>{var T,w;const A=Math.floor(Date.now()*1e3),c=(T=a.entries)==null?void 0:T[0];return{id:i,traceId:e,timestamp:A,duration:Math.floor(c.duration*1e3),name:"TTFB",tags:{"http.method":"GET","http.path":d,"web.vital.name":"TTFB","web.vital.description":a.description,"web.vital.value":a.value.toString(),"web.vital.rating":a.rating||"unknown","web.vital.delta":((w=a.delta)==null?void 0:w.toString())||"N/A","ttfb.fetch_time":(c.fetchStart-c.navigationStart).toString(),"ttfb.dns_time":(c.domainLookupEnd-c.domainLookupStart).toString(),"ttfb.connect_time":(c.connectEnd-c.connectStart).toString(),"ttfb.request_time":(c.responseStart-c.requestStart).toString(),"ttfb.response_time":(c.responseEnd-c.responseStart).toString(),"http.response_content_length":c.encodedBodySize.toString(),"http.response_transfer_size":c.transferSize.toString(),"http.response_decoded_content_length":c.decodedBodySize.toString(),"http.status_code":c.responseStatus.toString(),"network.protocol.name":c.nextHopProtocol||"unknown","network.protocol.version":c.nextHopProtocol?c.nextHopProtocol.split("/")[1]:"unknown","ttfb.initiatorType":c.initiatorType,"ttfb.deliveryType":c.deliveryType,"ttfb.renderBlockingStatus":c.renderBlockingStatus,"ttfb.workerStart":c.workerStart.toString(),"ttfb.redirectCount":c.redirectCount.toString(),"performance.domInteractive":c.domInteractive.toString(),"performance.domContentLoadedEvent":(c.domContentLoadedEventEnd-c.domContentLoadedEventStart).toString(),"performance.loadEvent":(c.loadEventEnd-c.loadEventStart).toString(),"qryn-view.instance":r},localEndpoint:{serviceName:"Web Vitals"}}},l=(a,d)=>({id:i,traceId:e,timestamp:o,duration:Math.floor(a.value*1e3),name:"INP",tags:{"http.method":"GET","inp.name":a.name,"inp.page":d,"inp.value":a.value,"inp.rating":a.rating,"inp.delta":a.delta,"qryn-view.instance":r},localEndpoint:{serviceName:"Web Vitals"}});let p={id:i,traceId:e,timestamp:o,duration:Math.floor(t.value*1e3),name:t.name,localEndpoint:{serviceName:"Web Vitals"}},h={"http.method":"GET","http.path":n,"web.vital.name":t.name,"web.vital.description":t.description,"web.vital.value":t.value.toString(),"web.vital.rating":t.rating||"unknown","web.vital.delta":((U=t.delta)==null?void 0:U.toString())||"N/A","qryn-view.instance":r};p.tags=h;let S=[];if(t.name==="TTFB"){p=u(t,n);const a=(j=t.entries)==null?void 0:j[0];if(a){const d=a.startTime;S=[s("Navigation Start",a.startTime,e,i,a.startTime,{"ttfb.startTime":a.startTime}),s("Fetch Start",a.fetchStart,e,i,a.fetchStart,{"ttfb.fetchStart":a.fetchStart}),s("Domain Lookup",a.domainLookupEnd-a.domainLookupStart,e,i,a.domainLookupStart-d,{"ttfb.domainLookupStart":a.domainLookupStart,"ttfb.domainLookupEnd":a.domainLookupEnd}),s("Connect",a.connectEnd-a.connectStart,e,i,a.connectStart-d,{"ttfb.connectStart":a.connectStart,"ttfb.connectEnd":a.connectEnd}),s("Request/Response",a.responseEnd-a.requestStart,e,i,a.requestStart-d,{"ttfb.requestStart":a.requestStart,"ttfb.requestEnd":a.requestEnd}),s("Unload Event",a.unloadEventEnd-a.unloadEventStart,e,i,a.unloadEventStart-d,{"ttfb.unloadEventStart":a.unloadEventStart,"ttfb.unloadEventEnd":a.unloadEventEnd}),s("DOM Interactive",0,e,i,a.domInteractive-d,{"ttfb.domInteractive":a.domInteractive}),s("DOM Content Loaded",a.domContentLoadedEventEnd-a.domContentLoadedEventStart,e,i,a.domContentLoadedEventStart-d,{"ttfb.domContentLoadedEventStart":a.domContentLoadedEventStart,"ttfb.domContentLoadedEventEnd":a.domContentLoadedEventEnd}),s("DOM Complete",0,e,i,a.domComplete-d,{"ttfb.domComplete":a.domComplete}),s("Load Event",a.loadEventEnd-a.loadEventStart,e,i,a.loadEventStart-d,{"ttfb.loadEventStart":a.loadEventStart,"ttfb.loadEventEnd":a.loadEventEnd})]}}if(t.name==="INP"){p=l(t,n);const a=(H=ut(t.entries))==null?void 0:H.map(d=>s(d.name,Math.round(d.processingEnd-d.processingStart),e,i,Math.round(d.processingStart),{"inp.name":d.name,"inp.interactionId":d.interactionId,"inp.startTime":d.startTime,"inp.processingStart":d.processingStart,"inp.processingEnd":d.processingEnd,"inp.cancellable":d.cancelable,"inp.count":d.count,"qryn-view.instance":r}));(a==null?void 0:a.length)>0&&(S=a)}let W=[p];return((J=Object.keys(S))==null?void 0:J.length)>0&&(W=[p,...S]),W},Vt=async t=>{try{await fetch(At,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}catch(n){console.error("Error sending trace data:",n)}};async function lt(t){if(t.size!==0)try{const{qrynInstance:n}=_.getState(),e=Array.from(t),r=await xt(e,n).then(u=>u),o=Ot(e,n),i=qt(o),s=e.flatMap(({metric:u,page:l,traceId:p,instance:h})=>_t(u,l,p,h));await Promise.all([Dt(i),Ft(r),Vt(s)]),t.clear()}catch(n){console.error("Error flushing queue:",n)}}const pt=async t=>{document.visibilityState==="hidden"&&await lt(t)},Bt=(t,n)=>{const{qrynInstance:e}=_.getState(),r=async o=>{const i=O().replace(/-/g,"");t.add({metric:o,page:n,traceId:i,instance:e})};mt(r),rt(r),bt(r),Tt(r),Ct(r),addEventListener("visibilitychange",()=>pt(t))},Wt=({page:t})=>{const{webVitalsActive:n}=_();ft.useEffect(()=>{const e=new Set;return n&&Bt(e,t),()=>{n&&(document.removeEventListener("visibilitychange",()=>pt(e)),lt(e))}},[])};export{It as L,Nt as M,At as T,Wt as u,O as v};
